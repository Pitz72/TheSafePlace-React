# v1.4.1 - "The Humanoid Fix"

**Data**: 22 Ottobre 2025  
**Tipo**: Hotfix & Enhancement

---

## üîß **Fix Tecnici Post-Implementazione**

Durante l'implementazione delle nuove funzionalit√† sono stati identificati e corretti **13 errori di linting**:

### **types.ts**
‚úÖ Aggiunto `JournalEntryType.SYSTEM_MESSAGE` all'enum  
‚úÖ Aggiunto `rest: (amount: number) => void` all'interfaccia `CharacterState`  
‚úÖ Aggiunti `toJSON` e `fromJSON` alle interfacce `CharacterState` e `GameStoreState`

### **store/characterStore.ts**
‚úÖ Corretto tipo `Set<unknown>` ‚Üí `Set<string>` in `fromJSON()` (riga 1124)

### **store/gameStore.ts**
‚úÖ Aggiunta funzione `restoreState` mancante  

### **store/interactionStore.ts**
‚úÖ Aggiunta propriet√† `isOpen: true` a `refugeMenuState` (riga 582)

**Build Status Finale**: ‚úÖ **0 errori TypeScript** | ‚úÖ **0 errori di compilazione**

---

## Problema Identificato

Durante l'analisi della cutscene `CS_FIRST_KILL` ("Il Peso della Sopravvivenza"), sono emersi due problemi critici:

### 1. La Cutscene Non Si Attivava Mai

Il trigger della cutscene era configurato per attivarsi dopo la "prima vittoria in combattimento", verificando se `totalCombatWins === 0`. Tuttavia, il counter `totalCombatWins` **non veniva mai incrementato** nel codice. Il valore rimaneva sempre a 0, impedendo l'attivazione della cutscene.

### 2. Incoerenza Narrativa

La cutscene √® scritta esplicitamente per l'uccisione di un essere umano:

> *"Il corpo giace immobile ai tuoi piedi... Non era un mostro. Era una persona."*

Tuttavia, il trigger si sarebbe attivato anche dopo aver sconfitto una bestia (lupo mutato, orso, cinghiale), creando una disconnessione narrativa totale. Il peso morale e psicologico della prima uccisione umana sarebbe stato completamente vanificato se applicato a un animale.

---

## Soluzioni Implementate

### 1. Sistema di Categorizzazione Nemici

**File modificati:**
- `types.ts`: Aggiunto type `EnemyType = 'humanoid' | 'beast'`
- `types.ts`: Aggiunta propriet√† `type: EnemyType` all'interfaccia `Enemy`
- `data/enemies.json`: Aggiunta propriet√† `"type"` a tutti i 14 nemici nel database
- `public/data/enemies.json`: Sincronizzato con le modifiche

**Categorizzazione:**

**Humanoid (9 nemici):**
- `raider_desperate` - Predone Disperato
- `raider_archer` - Predone con Arco
- `hostile_merchant` - Mercante Ostile
- `mad_hunter` - Cacciatore Folle
- `armed_raider` - Predone Armato
- `city_ghoul` - Ghoul Cittadino (ex-umano mutato)
- `crazed_guard` - Guardia Impazzita
- `desperate_wanderer` - Viandante Disperato
- `armed_survivor` - Sopravvissuto Armato

**Beast (5 nemici):**
- `mutated_wolf` - Lupo Mutato
- `wild_dog` - Cane Selvatico
- `mutated_bear` - Orso Mutato
- `aggressive_boar` - Cinghiale Aggressivo
- `mutant_beast` - Bestia Mutante

### 2. Fix del Counter Combattimenti

**File modificato:** `store/combatStore.ts` (righe 281-284)

**Problema:** Il valore `totalCombatWins` non veniva mai incrementato.

**Soluzione:** Aggiunta chiamata a `useGameStore.setState()` per incrementare il counter alla vittoria:

```typescript
// Increment total combat wins counter
useGameStore.setState(state => ({ 
    totalCombatWins: state.totalCombatWins + 1 
}));
```

Questo fix ripristina la funzionalit√† dei trigger della Main Story che dipendono da `totalCombatWins` (es. Capitolo 6 che richiede 3 vittorie).

### 3. Trigger Contestuale CS_FIRST_KILL

**File modificato:** `store/combatStore.ts` (righe 286-296)

**Cambiamento:**

**Prima:**
```typescript
if (totalCombatWins === 0 && !gameFlags.has('FIRST_KILL_PLAYED')) {
    // ...trigger cutscene
}
```

**Dopo:**
```typescript
const isHumanoid = combatState.enemy.type === 'humanoid';
if (isHumanoid && !gameFlags.has('FIRST_HUMAN_KILL_PLAYED')) {
    // ...trigger cutscene
}
```

**Miglioramenti:**
- La cutscene si attiva **solo** dopo la prima vittoria contro un nemico di tipo `humanoid`
- Cambio del flag da `FIRST_KILL_PLAYED` a `FIRST_HUMAN_KILL_PLAYED` per maggiore chiarezza semantica
- Il giocatore pu√≤ sconfiggere qualsiasi numero di bestie prima: la cutscene aspetter√† il primo umano ucciso

---

## Impatto sul Gameplay

### Scenario di Test

**Prima del fix:**
1. Giocatore incontra un Lupo Mutato ‚Üí Combatte ‚Üí Vince
2. `totalCombatWins` rimane a 0 (BUG)
3. Cutscene CS_FIRST_KILL si attiva ‚Üí **Incoerenza narrativa** (parla di uccidere una persona)

**Dopo il fix:**
1. Giocatore incontra un Lupo Mutato ‚Üí Combatte ‚Üí Vince
2. `totalCombatWins` incrementa a 1 ‚úÖ
3. Cutscene CS_FIRST_KILL **NON** si attiva (il lupo √® `type: beast`) ‚úÖ
4. Giocatore incontra un Predone Disperato ‚Üí Combatte ‚Üí Vince
5. `totalCombatWins` incrementa a 2 ‚úÖ
6. Cutscene CS_FIRST_KILL si attiva ‚úÖ ‚Üí **Coerenza narrativa perfetta**

### Vantaggi

1. **Coerenza Narrativa Assoluta**: La cutscene emotiva sull'uccisione umana si attiva esattamente quando dovrebbe
2. **Progressione Naturale**: Il giocatore pu√≤ affrontare bestie per fare pratica prima del trauma morale
3. **Impatto Emotivo Massimizzato**: Il "pugno nello stomaco" narrativo arriva al momento giusto
4. **Flessibilit√† di Design**: Possiamo creare trigger specifici per bestie vs umanoidi in futuro

---

## Testing e Validazione

### Build Status
‚úÖ **Build completato con successo** (914ms)
‚úÖ **Nessun errore di compilazione TypeScript**
‚úÖ **83 moduli trasformati correttamente**

### File Aggiornati
- `types.ts` - Nuova interfaccia tipo nemico
- `data/enemies.json` - 14 nemici categorizzati
- `public/data/enemies.json` - Sincronizzato per produzione
- `store/combatStore.ts` - Fix counter + trigger contestuale

---

## Note di Versioning

Questa √® una **hotfix critica** che risolve:
1. Un **bug funzionale** (counter non incrementato)
2. Una **rottura narrativa** (trigger generico invece di contestuale)

La versione minore viene incrementata a 1.4.1 poich√©:
- Non ci sono breaking changes nell'API
- I salvataggi esistenti rimangono compatibili
- √à una correzione e un miglioramento, non una feature nuova

---

## Compatibilit√† Salvataggi

‚úÖ **Pienamente retrocompatibile**

I salvataggi pre-1.4.1 continueranno a funzionare. Il flag `FIRST_KILL_PLAYED` non √® mai stato settato (per via del bug), quindi non ci sono conflitti con il nuovo flag `FIRST_HUMAN_KILL_PLAYED`.

---

## Modifica Aggiuntiva: CS_BEING_WATCHED

### Problema Identificato

La cutscene `CS_BEING_WATCHED` ("L'Ombra che non fa Rumore") si attivava **solo** quando il giocatore tentava di riposare al giorno 2 o successivo. Questo creava un problema:

- Se il giocatore evitava di riposare (usando solo rifugi), la cutscene **non si attivava mai**
- Questa cutscene √® **narrativamente necessaria** perch√© introduce gli Angeli della Cenere e crea tensione

### Soluzione Implementata

**File modificato:** `store/gameStore.ts`

**Cambiamenti:**

1. **Rimosso il trigger da `performQuickRest()`** (righe 282-291)
   - La cutscene non √® pi√π legata all'azione di riposo

2. **Aggiunto trigger automatico in `checkCutsceneTriggers()`** (righe 490-495)
   ```typescript
   // CS_BEING_WATCHED: Automatically triggers at day 3
   if (gameTime.day >= 3 && !state.gameFlags.has('BEING_WATCHED_PLAYED')) {
       set(s => ({ gameFlags: new Set(s.gameFlags).add('BEING_WATCHED_PLAYED') }));
       state.startCutscene('CS_BEING_WATCHED');
       return;
   }
   ```

**Risultato:**
- La cutscene si attiva **automaticamente** all'inizio del giorno 3
- Non importa se il giocatore riposa o meno
- La scena viene sempre mostrata, garantendo continuit√† narrativa

### Vantaggi

‚úÖ **Cutscene garantita**: Ogni giocatore vedr√† questa scena importante  
‚úÖ **Introduzione degli Angeli della Cenere**: Il concept sovrannaturale viene sempre presentato  
‚úÖ **Tensione narrativa**: La paranoia e il presagio sono elementi essenziali della storia

---

## Modifica Aggiuntiva: CS_ASH_LULLABY (La Ninnananna della Cenere)

### Problemi Identificati

La cutscene `CS_ASH_LULLABY` √® il **climax emotivo e narrativo** del gioco, rivelando la verit√† sulla madre di Ultimo e la natura degli Angeli della Cenere. Tuttavia, presentava problemi di trigger:

**Trigger Precedente:**
```typescript
mainStoryStage >= 10 && playerPos.x > 80 && hasMusicBox
```

**Problemi:**
1. **Richiede progressione di storia avanzata** (stage 10/12) ‚Üí Troppo tardi
2. **Richiede posizione geografica specifica** (x > 80) ‚Üí Il giocatore potrebbe non arrivare mai l√¨
3. **Rischio di cutscene mai vista** ‚Üí Rottura narrativa catastrofica

### Soluzione Implementata

**File modificato:** `store/interactionStore.ts` (righe 495-502)

**Nuovo Trigger:**
```typescript
// CS_ASH_LULLABY trigger: First refuge at night on day 3+
const isNight = gameTime.hour >= 20 || gameTime.hour < 6;
if (gameTime.day >= 3 && isNight && !gameFlags.has('ASH_LULLABY_PLAYED')) {
    // Attiva schermata di scelta
}
```

**Condizioni:**
- ‚úÖ **Giorno 3 o successivo**
- ‚úÖ **Primo rifugio di notte** (20:00-6:00)
- ‚úÖ **Carillon gi√† posseduto dall'inizio** (confermato in `characterStore.ts` riga 101)

**Rimozioni:**
- ‚ùå Controllo `mainStoryStage >= 10` (troppo restrittivo)
- ‚ùå Controllo `playerPos.x > 80` (area geografica specifica)
- ‚ùå Controllo `hasMusicBox` (ridondante, il giocatore lo ha sempre)

### Vantaggi

‚úÖ **Cutscene garantita**: Ogni giocatore la vedr√† al giorno 3  
‚úÖ **Timing narrativo ottimale**: Dopo CS_BEING_WATCHED (giorno 3), prima del mid-game  
‚úÖ **Atmosfera perfetta**: La notte amplifica la tensione e l'orrore della scena  
‚úÖ **Rivelazione anticipata**: Il mistero della madre si svela prima, creando maggiore impatto emotivo per il resto del viaggio

### Note sul Carillon

Il `carillon_annerito` √® **gi√† dato all'inizio** del gioco nell'inventario iniziale. Non √® stato trovato alcun evento che lo d√† come ricompensa da sostituire.

---

## Conclusione

Questa patch risolve **tre problemi narrativi critici**:

1. **CS_FIRST_KILL**: Da trigger generico e buggy a momento narrativo contestuale e potente
2. **CS_BEING_WATCHED**: Da cutscene opzionale a evento garantito al giorno 3
3. **CS_ASH_LULLABY**: Da climax potenzialmente mancato a rivelazione garantita e anticipata

### Impatto Narrativo Complessivo

Le modifiche trasformano il gioco da un'esperienza **narrativamente fragile** dove cutscene essenziali potevano essere perse, a un'esperienza **narrativamente robusta** dove ogni momento chiave √® garantito e ottimamente posizionato.

**Progressione Narrativa Garantita:**
- Giorno 1: CS_OPENING (lettera del padre)
- Giorno 3: CS_BEING_WATCHED (introduzione Angeli della Cenere)
- Giorno 3+ notte: CS_ASH_LULLABY (rivelazione sulla madre)
- Primo umanoide ucciso: CS_FIRST_KILL (peso morale)

Il sistema di categorizzazione nemici apre inoltre la strada a meccaniche future (talenti specifici, reazioni morali differenziate, achievement separati).

**Il peso della sopravvivenza ora ha il peso giusto. E ogni storia viene raccontata.**

---

## Nuove Cutscene Contestuali: "Pi√π Cinema"

Aggiunte 4 nuove cutscene brevi ma potenti per arricchire l'esperienza narrativa e trasformare momenti meccanici in momenti cinematici.

### 1. CS_THE_WEIGHT_OF_CHOICE ("Il Peso della Scelta")

**Trigger**: Prima scelta morale significativa (allineamento ¬±3 o pi√π in un singolo evento)

**Scopo**: Rendere il sistema di allineamento meno "gamificato" e pi√π narrativo, mostrando le conseguenze emotive delle scelte.

**Testo**: 2 pagine
- Pagina 1: Il giocatore prosegue dopo la scelta, convinto di aver fatto "la cosa giusta"
- Pagina 2: Quella notte, la voce del padre risuona nella testa. Il peso morale della scelta diventa tangibile.

**Implementazione**:
- File: `store/characterStore.ts` - Funzione `changeAlignment()`
- Delay di 1 secondo per permettere all'evento di completarsi
- Flag: `WEIGHT_OF_CHOICE_PLAYED`

**Impatto**: Trasforma le scelte morali da "numeri che cambiano" a momenti di riflessione emotiva.

---

### 2. CS_CITY_OF_GHOSTS ("La Citt√† dei Fantasmi")

**Trigger**: Primo ingresso in una casella di tipo Citt√† (**PRIORIT√Ä ALTA** - prima degli eventi citt√†)

**Scopo**: Dare un peso monumentale all'arrivo nelle rovine urbane, differenziandole nettamente dagli altri biomi.

**Testo**: 2 pagine
- Pagina 1: L'aria cambia. Scheletri di grattacieli. Canyon silenziosi. Un'impressione viscerale di scala e morte.
- Pagina 2: Confronto tra l'addestramento del padre (natura, predoni) e questo nuovo orrore: il cimitero di un'intera civilt√†.

**Implementazione**:
- File: `store/gameStore.ts` - Funzione `checkCutsceneTriggers()` 
- **Priorit√† MASSIMA**: Si attiva PRIMA di CS_BEING_WATCHED e prima degli eventi citt√†
- Flag: `CITY_OF_GHOSTS_PLAYED`

**Impatto**: L'ingresso in citt√† diventa un momento memorabile, non solo un cambio di tileset.

---

### 3. CS_STRANGERS_REFLECTION ("Il Riflesso di uno Sconosciuto")

**Trigger**: Raggiungimento del livello 5 (met√† gioco)

**Scopo**: Collegare la meccanica del level-up a un momento narrativo di crescita e consapevolezza del personaggio.

**Testo**: 2 pagine
- Pagina 1: Ultimo vede il suo riflesso nell'acqua. Il volto che lo guarda non √® pi√π quello del ragazzo che ha lasciato il rifugio.
- Pagina 2: Chi √® diventato? La creatura forgiata da Elian, o qualcosa di nuovo? La risposta lo spaventa... o forse lo affascina.

**Implementazione**:
- File: `store/characterStore.ts` - Funzione `applyLevelUp()`
- Si attiva specificamente quando `newLevel === 5`
- Delay di 500ms dopo i trigger standard
- Flag: `STRANGERS_REFLECTION_PLAYED`

**Impatto**: Il livello 5 non √® solo "stat +1", ma un momento di trasformazione narrativa visibile.

---

### 4. CS_THE_BRINK ("Sull'Orlo") ‚≠ê **CON BONUS MECCANICO**

**Trigger**: HP scende sotto il 10% per la prima volta

**Scopo**: Trasformare un momento di debolezza meccanica in un momento di forza narrativa, premiando il giocatore per aver superato la soglia della morte.

**Testo**: 2 pagine
- Pagina 1: Ultimo cade in ginocchio. La vista si oscura. Il sapore del sangue. √à la fine?
- Pagina 2: La voce del padre: "Sopravvivi." Non √® incoraggiamento. √à un ordine. Rabbia pura. Ultimo si rialza.

**Implementazione**:
- File: `store/characterStore.ts` - Funzione `takeDamage()`
- Trigger: `(HP / HPmax) * 100 < 10`
- Delay di 1 secondo per permettere la visualizzazione del danno
- Flag: `THE_BRINK_TRIGGERED`
- **BONUS PREMIO**: +25% a TUTTI gli attributi (FOR, DES, COS, INT, SAG, CAR)
- Messaggio: "[SOPRAVVISSUTO ALL'ORLO] La tua determinazione ti ha reso pi√π forte!"

**Impatto**: Una ricompensa narrativa E meccanica per aver sfiorato la morte. Il momento pi√π disperato diventa un power-up permanente.

---

## Gestione Priorit√† e Timing

### Ordine di Trigger Cutscene (da pi√π alta a pi√π bassa priorit√†):

1. **CS_CITY_OF_GHOSTS** - Primo ingresso citt√† (MASSIMA)
2. **CS_BEING_WATCHED** - Giorno 3
3. **CS_RIVER_INTRO** - Vicino acqua
4. **CS_HALF_JOURNEY** - 100 passi + giorno 3
5. **CS_POINT_OF_NO_RETURN** - Vicino destinazione

### Cutscene con Delay Intenzionale:

- **CS_THE_WEIGHT_OF_CHOICE**: 1000ms dopo cambio allineamento (permette completamento evento)
- **CS_THE_BRINK**: 1000ms dopo danno (permette visualizzazione HP)
- **CS_STRANGERS_REFLECTION**: 500ms dopo level-up (dopo trigger standard)

### Note sulla Compatibilit√† Eventi:

Le cutscene si attivano in **modalit√† "return"** - terminano immediatamente `checkCutsceneTriggers()` impedendo attivazioni multiple. Gli eventi citt√† si attivano DOPO CS_CITY_OF_GHOSTS, quando il giocatore si muove nuovamente.

---

## Statistiche Finali v1.4.1

**Cutscene Totali**: 11
- 7 cutscene esistenti (corrette e ottimizzate)
- 4 nuove cutscene contestuali

**Trigger Garantiti**: 100%
- Ogni cutscene essenziale si attiva con certezza
- Nessuna dipendenza da RNG o posizioni specifiche (tranne CS_POINT_OF_NO_RETURN, opzionale)

**Momenti Cinematici**:
- Giorno 1: Lettera del padre
- Giorno 3: Angeli della Cenere
- Giorno 3+ notte: Rivelazione madre
- Prima scelta morale: Peso della coscienza
- Primo umanoide ucciso: Trauma morale
- Livello 5: Trasformazione visibile
- HP < 10%: Sopravvivenza all'orlo + power-up
- Prima citt√†: Immensit√† urbana

**Il peso della sopravvivenza ora ha il peso giusto. E ogni storia viene raccontata.**

