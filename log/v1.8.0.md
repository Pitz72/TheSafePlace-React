
# Changelog v1.8.0 - Quest Expansion & World Interaction

**Data Rilascio:** 31 Ottobre 2025  
**Tipo Release:** Major Feature Release  
**Tempo Sviluppo:** 4 ore effettive  
**Stato:** ‚úÖ Completato

---

## üéØ PANORAMICA

La versione 1.8.0 espande massivamente il **Quest System Framework** (v1.5.0) con **5 nuove subquest**, **3 nuovi trigger types**, e **2 nuovi sistemi** che trasformano il gioco da "RPG con quest" a "RPG con mondo interattivo e persistente".

### Obiettivi Principali

1. [x] Implementare 3 nuovi trigger types (hasItems, talkToNPC, completeEvent)
2. [x] Creare World State System per modifiche permanenti al mondo
3. [x] Implementare Archivio Lore per scoperte narrative
4. [x] Aggiungere 5 nuove subquest giocabili
5. [x] Integrare profondamente con sistemi dialogo e social

---

## üìä STATISTICHE DI MODIFICA

| Categoria | v1.7.0 | v1.8.0 | Incremento |
|-----------|--------|--------|------------|
| **Subquest Giocabili** | 1 | 5 | +400% |
| **Quest Trigger Types** | 2 | 5 | +150% |
| **Sistemi Core** | 10 | 12 | +20% |
| **Lore Entries** | 0 | 3 | +‚àû |
| **World Interactions** | 0 | 1 | +‚àû |
| **Nodi Dialogo Marcus** | 6 | 9 | +50% |
| **Eventi Unici** | ~15 | ~18 | +20% |

---

## ‚ú® NUOVE FUNZIONALIT√Ä

### 1. Nuovi Trigger Types (3)

#### hasItems - Check Inventario Multiplo
```typescript
trigger: {
  type: "hasItems",
  value: [
    { itemId: "rubber_gasket", quantity: 1 },
    { itemId: "scrap_metal", quantity: 2 }
  ]
}
```

**Comportamento:**
- Controlla passivamente l'inventario del player
- Avanza automaticamente quando tutti gli item sono presenti
- Usato in "La Pompa Silenziosa" per raccolta materiali

#### talkToNPC - Dialogo con NPC Specifico
```typescript
trigger: {
  type: "talkToNPC",
  value: "marcus_investigation_start"
}
```

**Comportamento:**
- Si attiva quando player visita nodo dialogo specifico
- Integrato in dialogueService.selectOption()
- Usato in "Indagine al Crocevia" e "Il Messaggio del Fiume"

#### completeEvent - Completamento Evento Unico
```typescript
trigger: {
  type: "completeEvent",
  value: "unique_ancient_library"
}
```

**Comportamento:**
- Si attiva quando evento unico viene completato
- Integrato in eventStore.dismissEventResolution()
- Usato per lore quests auto-complete

### 2. World State System ‚ú® NUOVO

**Descrizione:**
Sistema per tracciare modifiche permanenti al mondo di gioco che persistono tra save/load.

**Implementazione:**
```typescript
interface WorldState {
  repairedPumps: Position[];
  destroyedPumps: Position[];
}

// Actions
activateWaterPump(location: Position): void
destroyWaterPump(location: Position): void
canUseWaterPump(location: Position): boolean
```

**Features:**
- Pompe d'acqua riparabili con skill check
- Stato permanente (riparata/distrutta)
- Interazione ripetibile con pompe riparate
- Visual markers sulla mappa (futuro)
- Persistenza save/load completa

**Uso in "La Pompa Silenziosa":**
- Player trova pompa rotta
- Raccoglie materiali (hasItems trigger)
- Torna alla pompa (reachLocation trigger)
- Skill check Investigare DC 13
- Successo: Pompa funzionante permanentemente
- Fallimento: Pompa distrutta permanentemente

### 3. Archivio Lore System ‚ú® NUOVO

**Descrizione:**
Sistema per collezionare e rileggere scoperte narrative importanti.

**Implementazione:**
```typescript
interface LoreEntry {
  id: string;
  title: string;
  text: string;
  category: 'project' | 'history' | 'character' | 'world';
}

// In characterStore
loreArchive: string[]; // Array of unlocked entry IDs
addLoreEntry(entryId: string): void
```

**Database:**
- [`data/lore_archive.json`](data/lore_archive.json:1) - 3 entries iniziali
- [`data/loreArchiveDatabase.ts`](data/loreArchiveDatabase.ts:1) - Loader

**Entries Iniziali:**
1. **Sul Progetto Eco** - Interfaccia neurale collettiva
2. **Sul Progetto Rinascita** - Antidoto al Grande Silenzio
3. **Il Clan del Corvo** - Storia di Jonas e gli esploratori

**UI Integration:**
- Terza colonna in QuestScreen: "ARCHIVIO LORE"
- Layout 3 colonne: Main | Sub | Lore
- Testo completo leggibile
- Color-coded violet (#a78bfa)

---

## üéÆ NUOVE SUBQUEST (5)

### Subquest #1: "La Pompa Silenziosa"

**Tipo:** SUB  
**Complessit√†:** Alta  
**Trigger Usati:** hasItems, reachLocation

**Flusso:**
1. Trova pompa rotta in villaggio (45, 85)
2. Quest attivata: "Raccogli materiali"
3. Trova 1√ó Guarnizione Gomma + 2√ó Rottami
4. Quest avanza automaticamente (hasItems)
5. Torna alla pompa
6. Skill check Investigare DC 13
7. **Successo:** Pompa funzionante + 200 XP
8. **Fallimento:** Pompa distrutta + 30 XP

**Ricompensa Permanente:**
- Fonte acqua infinita a (45, 85)
- Interazione ripetibile: +3 Acqua Pulita

**Eventi:**
- `trigger_pump_quest` - Attivazione
- `complete_pump_repair` - Riparazione
- `use_water_pump` - Uso ripetibile

### Subquest #2: "Indagine al Crocevia"

**Tipo:** SUB  
**Complessit√†:** Media  
**Trigger Usati:** talkToNPC, reachLocation, getItem

**Flusso:**
1. Trova bacheca villaggio
2. Leggi avviso Marcus
3. Quest attivata: "Parla con Marcus"
4. Vai al Crocevia (A tile)
5. Dialogo Marcus ‚Üí marcus_investigation_start
6. Quest avanza (talkToNPC)
7. Marker appare a (95, 50)
8. Trova accampamento ladro
9. 3 scelte: Furtivit√† DC 14 / Combattimento / Persuasione DC 16
10. Ottieni old_watch
11. Torna da Marcus
12. Dialogo ‚Üí marcus_investigation_complete
13. Scegli arma (Pugnale Affilato / Arco Improvvisato)

**Ricompense:**
- 300 XP
- Arma uncommon a scelta
- Flag MARCUS_FRIENDSHIP
- **Sconto permanente 10%** in tutti gli scambi con Marcus

**Eventi:**
- `village_community_board` - Attivazione (modificato)
- `unique_thief_camp` - Accampamento ladro

**Dialoghi:**
- `marcus_investigation_start` - Info sul ladro
- `marcus_investigation_complete` - Ricompensa

### Subquest #3: "La Conoscenza Perduta"

**Tipo:** SUB (Lore Quest)  
**Complessit√†:** Bassa  
**Trigger Usati:** completeEvent

**Flusso:**
1. Vai a Biblioteca (B tile)
2. Completa evento unique_ancient_library
3. Quest auto-start e auto-complete
4. Lore entry "Sul Progetto Eco" sbloccata

**Ricompense:**
- 150 XP
- +1 INT permanente
- Lore entry in Archivio

### Subquest #4: "L'Eco del Silenzio"

**Tipo:** SUB (Lore Quest)  
**Complessit√†:** Bassa  
**Trigger Usati:** completeEvent

**Flusso:**
1. Vai a Laboratorio (L tile)
2. Completa evento unique_scientist_notes
3. Quest auto-start e auto-complete
4. Lore entry "Sul Progetto Rinascita" sbloccata

**Ricompense:**
- 150 XP
- +1 INT permanente
- Lore entry in Archivio

### Subquest #5: "Il Messaggio del Fiume" (REWORK)

**Tipo:** SUB  
**Complessit√†:** Media  
**Trigger Usati:** reachLocation, getItem, talkToNPC

**Modifiche da v1.5.0:**
- Aggiunto Stage 3: "Parla con Marcus sul simbolo"
- Ricompensa cambiata: Miele ‚Üí Manual Trappole Avanzate
- XP aumentato: 150 ‚Üí 250
- Integrazione dialogo Marcus

**Flusso Completo:**
1. Trova bottiglia fiume
2. Leggi messaggio ‚Üí Quest attivata
3. Vai a mulino (78, 9)
4. Skill check Percezione DC 12
5. Trova jonas_talisman
6. Quest avanza a stage 3
7. Vai al Crocevia
8. Dialogo Marcus ‚Üí marcus_talisman_knowledge
9. Marcus racconta storia Clan del Corvo
10. Quest completa

**Ricompense:**
- 250 XP (+100 da v1.5.0)
- Manual: Trappole Avanzate (sblocca recipe_advanced_bear_trap)
- Lore entry "Il Clan del Corvo"

**Dialogo:**
- `marcus_talisman_knowledge` - Storia del Clan

**Nuova Ricetta:**
- `recipe_advanced_bear_trap` - Trappola sofisticata (trap value 5)

---

## üìÅ FILE MODIFICATI

### Core Systems (6)

**types.ts** (+30 righe)
- Aggiunti 3 trigger types: hasItems, talkToNPC, completeEvent
- Interfacce WorldState e LoreEntry
- Aggiornate interfacce GameStoreState e CharacterState

**store/gameStore.ts** (+100 righe)
- worldState: { repairedPumps, destroyedPumps }
- activateWaterPump(), destroyWaterPump(), canUseWaterPump()
- Serializzazione worldState in toJSON/fromJSON

**store/characterStore.ts** (+40 righe)
- loreArchive: string[]
- addLoreEntry() con journal feedback
- Serializzazione loreArchive in toJSON/fromJSON

**services/questService.ts** (+80 righe)
- Implementati trigger hasItems, talkToNPC, completeEvent
- Logica eventi contestuali per pump e thief
- Special completion effects (Marcus friendship, lore entries)
- Signature aggiornata: checkQuestTriggers(itemId?, nodeId?, eventId?)

**services/dialogueService.ts** (+5 righe)
- Quest trigger check dopo jumpToNode
- Integration con questService

**services/tradingService.ts** (+15 righe)
- Marcus friendship discount (10% additional)
- Journal feedback per sconto amicizia

**store/eventStore.ts** (+30 righe)
- Handler activateWaterPump/destroyWaterPump
- Quest trigger check dopo event completion
- Auto-start/complete lore quests
- Integration con loreArchive

**services/gameService.ts** (+15 righe)
- Water pump interaction check
- Evento use_water_pump quando su pompa riparata

**App.tsx** (+5 righe)
- Import e load loreArchiveDatabase

### Database & Content (8)

**data/quests.json** (rework completo)
- Modificata find_jonas_talisman (aggiunto stage 3)
- Aggiunta repair_water_pump
- Aggiunta crossroads_investigation
- Aggiunta lore_quest_library
- Aggiunta lore_quest_laboratory

**data/lore_archive.json** (NUOVO - 28 righe)
- 3 lore entries complete

**data/loreArchiveDatabase.ts** (NUOVO - 99 righe)
- Loader pattern standard

**data/events/village_pump.json** (NUOVO - 117 righe)
- trigger_pump_quest
- complete_pump_repair
- use_water_pump

**data/events/forest_thief.json** (NUOVO - 64 righe)
- unique_thief_camp (3 scelte)

**data/events/village.json** (+40 righe)
- Aggiunto village_community_board

**data/eventDatabase.ts** (+2 righe)
- Import village_pump.json e forest_thief.json

**public/data/dialogues.json** (+