extends Node

# Map Data String (from GDD 10)
const MAP_STRING = """..................R...............~CCC.................................~...R.....~................~..............R..............................~.....
S...............~.................~CCC.................................~...R......................R..............................................~....
................~................~....................................~..........~............R.......................................................
...............~....................................R.................~..........~...............................................................~....
................~...............~.............................R......~............~...............~.................R...........................~.....
.................~............V.~....................................~.............................................................FFF................
....R.............~.............~................................................................................R.....................F..........~...
..................R~...........R.........R...........................~............................~..................................F................
..................~.............................................N...............~.............~...M............................F................~.
..................~..................................................~.....................................................R..........................
...................................................R.................~........................R..~....MM....................F.........................
.................~.............................R.............R.......~...FF..............................................C..F.........................
.................~............~..R....................................~.....FF.............R............................CC...........R................
........R.................R...~.R.......R................................F..F....................R..........R...........CCF.F.....................~...
........F....................~..............M.M....R................R.~....F.F.........................................CCCC.................R.........
.......F.......~............~....R..........M.............................F.F.................R...........R...............C.......................~..R
....RF.........~...R..........................M........................~FFFFFFF...................................................................~...
....CFFFRF....~.............~............VV.............................FF..F................................................R.R......................
..CCC..F.F...R.~............~........................................~F.FF.......~..................~...............................................~.
..CCCC....................................VV.......................R.~....F........................~............R............V.V......................
...CC.........~.............~...................................................~.................R...................................................
..CC.....R................R.............R...................R........~...........~................~...........................................R.....~
R........F.....F................R...............R.................................~...................................................R..F.........~..
.........F.F...~...........R........R..............................................~..............~.......................................F...........
.............F...R..................................................~.....V........~..............~................R...........R.........F............
.............F...............~.......F.....R.........R..................V..........~........F.F................................................R......
....C.C.C..FFFF..............~....F.................................................~.FF.....FF...~......................................F.F.........~
....CCCCCF.FF..F.V............M....F..................................R..............~....F.F.F....~..F...............................................
....CCCC..F...FV.~M..........~..F.....................R.............................R.F.FFF...F....~..F..F.F................F.F.......................
.......CC.......V~..........~....F.RF..............................~...................F.FF...F.....~.....FF.........M.M...F....................FF...~
......FCF..F.....~...........R....................................~...................~.F.....F.....~...FF............M......................F..F...~
...........F..............~............................................................RF...........~.F....F.........M.......F......R..R.....F.F..F...
......RF.FF...............~.......................................................................R.............................................F...~
..........FF.....................................................~....................~.............~.................................................
.........F............................................................................~...............................................R...............
............................~....................R..............~.......R....V....................M.~................................................~
..............R..........CC~C...................................R~..........R..................................................R......................
.............R...~.......CCC~.............R......................~.................R..~...........MF.R......................................R.........
.........................CCC.~....................M..............~..................................................................................~
..R.............~........CCC.....................A...............~....................~..........~..................................................~
.....M..........~.........CC.~....................MM.................................................F.FF......R...................................~..
...............~..............~.......................................................~...........FFF.F....................R.......................~..
..............~...............~.................................~......................~..........F..F..F.............................................
..............~................~........R.........R......R.....~........................~.........~RF..F.................R...........................~
..................~.............~................CCC....................................~.............................................................
..........~~.~...~.~~~~........~...........R.R..C.CCC...........................................~...M.....................R...........................
.......~~...~~~........~....~~.~....................C..........~................................~.M.................................................V.
.........~..~..~~.......~.~~..~~~~.............................~.........................................R.........................F..F.FF...........~
....R.~..................~....~.R.............~.........~..R....................................R~...............R.................FF...F...........R.
...........~......................~.........~~.~~~~~.M.~.........~.............R.........~.......~..............R...................F.RF........R.....
.....~........R......R.............~~......~........~M~..~~~~~~..~......................~.........~.................R...............F.....M.M.........
...........~.....R...........~.........~~~~....................~..~......................~........~...........................R......................~
...........R...R.............~.......~.............R............~..~.....................~...........................................F.FR....R.......~
...........~..................~.......~..........................~~~.................~~..~.......................R...................FFF.F........F.F~
...................R...............................................~R.~......~~~~~~~~..~~~.......~~....~.F~~F..........R.............................~
...........~.............................R........................~~~~..~..~~..........~..~~~...~~....~R.~F.~~F.....................................F.
................R.............~............................R......~....~.~~.........R..~.....~~~..V~~~..~.....~..........~~.R.......................F~
............~.................R.......................................................~...................F....~~~~~..~~~...........................~.
.................M.........................................................................................FF.......~~.....~~........F............F~F.
.................M.............~.................................~........................................F..F......R....................R.........~..
.........................R.....~......R.....R....R....................................~................R....R................~~.~.~~~.F.~~~........~..
..........~.................................................R..................................................................~.~...~~~...~~......~..
..........~.....................~..................................~..........M.......~............................................FF..............~..
...........~..................R.~.R......R.........R.R.........................M......~.........~............................................~~.....~.
.........................................V....................................M.................~.................................R.................~.
................................~........VV...........................................~.................................R......................~~~~~.~
....................................................................~...........................R..........R..........................................
...............................~...............................R.....F...............~....................................R...........................
........F.....................~.....................................~.F.FF..........~........~.......................................................~
......................................................M............~.F.FFF..........~........~..........................................R............~
.......F.......................~....................................................~.........~..................................R....................
..........F...................~............R..................CCC.....F.F.......R....~....................R..........................................~
.......F.F....................~................................CC..~................~.........~.......................................................
..........F...................~..............................C.CC.~.................~.........~..........R....R......................................~
..............................~..............................CC...~..........................~........................................................
...MM.............R...........~..............................CCC..............................~...................................................V...
...M.M.........................~..................................~..........R.....~.........~..................................R...................V.
...M................R..F.F.....~...................R..R...........~................~....................M.............................................
............................RC~.....................................................~........~........................................................
.......................F....CCC~....................................................~.................................................................
.............................CC~.............................................R.......~........................R.......................................
.........................F....C~...................................~.................R...............................................................~
.......................R.......~...R..............................~..R...............~.......~.....................................R..................
......................................................................................~......~........................................................
..FF.....R...................M..~............................................................~.......................R...............R................
.......F....................M........F..F.......................~......................~.....~.............................................R..........
..F.R.F............R...............R.F....R................................................R.~........................................................
.F..FF........................................R..................~......................~...~.........................................................
.F........M.........................................................................HR..~.............................................................
.F.FFF..MMM..........................F.FF..............................................~....~......................R..................................
...~~~~~~~.......................................................VV..........R............R.~....................................................R...R
~~~.......~....................................R........................................~...~......MM.................................................
...........~..........~..R....................R....................V...................~..........M.M..............................~~.................
............~........~.~~.......R...........................................................~.....................................~..~................
.............~~.....~....~~.............................................................~.....................................~.~~....~~~.............
..........R....~~~~~...................................~~...............................~RR.~......R..............R.........~~.~...R.....~~......R....
...........................~~~~..................~~..~~..~~.~~.............................................................~.................~~.......
....R..........................~~~~~~~~~.~.~~...~M.~~......~............~~...~~............R..............................~................~~..~......
........................................~.~..F~~F.F...........~~~~.....~..~.~.M....~.......~.......~~~~.......~~~~~~~~..~~............................
.......................R.....................~..F.................~..~~....~...~~~~...............~....~~~~.~~........~~........................~.....
......................................R.......F....F...............~~...............~~........~~~~.........~.....................................~....
.............................................MMFF.F...................R...............~..R...~........................................................
..............R..............................M.F.F............................R.........R.~........................................R..................
..............................................MFF......................................~~~.~~...............R..................R......................
.............................................FF.......................R...........R......~~...........................................................
.............................................................................R.................................R..CC..................................
...............................................................................................................R.CC.......R...............MM.........
........................VV...........................R.........................................C.C....R..........CCCC.......................MM........
.............F...........V.....................................................................CCCCC..........R..CCC.........................M........
............F........................................................F.F.............VV.........BLCC...R......R..C..C....R......................R.....
.........................................................R..............F.F...........V.........CCCC..................................................
.......................................................................F..FR...................FCCFC..................................................
........F.F...F.........................................................F.F.....................FF...F...............R................................
.......F..F...R.......................V.V...............................FF..................R..F.F....................................................
.....F.F..................R...........V.V..........................................................F....R...........FF...F............................
.....FF.FF............R................VV..........F..............................F................F..................F...............................
.........F...................R.....................FF.FF............................F.........F.FFF.................F.F...............................
R.........F.........................................F..........................................F.F..F..................F.F............................
....................................................F..F..........................F.F.......F............................F............................
.........F.................................R......F.FF..............................F..........FR....................F.F.F.......V.V.........R........
..........F.F.....R...................................................R..............................................R............V...................
..............F.......................R.R.............M.......R.............................FF....................................VVR.......R.R..R....
..................................R....................................................R..............................................................
...........................R.............R.V..................................................................VV............M.........................
........................................R...VV..............R.................................................VV......R......M........................
........R.....................R............................................................R......................................R...................
......................................................................................FF................................R...R.........................
.....................................................................................F.F.F......F.F...................................................
.................R.....R.............................................................F.....F.......F............................................R.....
...................................................................................................F......M...........................................
................R....................................R...................MM...........F.........FF...F...M.............R..........V...................
.........................F..........M.M....................................................F........................R...........V.V........R..........
..R....................F.F...........M..F................................MM...........F..F.F.....................................VV.R....R............
..............R.......................M.F..FF.............R...........................................................................................
......................FF...............................................................R................R.............................................
..................FFFF.F..F................R...................................................................................................R......
...................FF.....................F.........R.............................................................................................R...
................................MM..........F..............................R.....R....................................................................
.................................M........................................................................................F.F.........................
................................MM........................................................R..............................F....FF......................
.........................................................................................................................F.......F....................
.................R..F..FF..................................................................R.................................F.....R..................
.....................FFF........................................RF...............................................FF.......F.F.FFFF....................
.....................F.FF...........................R.............FFF.F.....R......................................F...........F......................
...................................R............................FFF..R...............................R................................................
............R.......F...F..........................................F.............................F.............F.F.............R......................
.M....................................R.........................F....F........................FF.....R...........................................E....
..........................R........................................FFRF......................F..F.......................................R.............
.M.M.................................VV...............................F........................F............R........................R.................
................................R...................R................................................................................................."""

# Tile Mapping (Atlas Coords)
const TILE_MAP = {
	'.': Vector2i(0, 0),   # Grass
	'F': Vector2i(1, 0),   # Forest
	'M': Vector2i(2, 0),   # Mountain
	'~': Vector2i(3, 0),   # Water
	'C': Vector2i(4, 0),   # City
	'#': Vector2i(5, 0),   # Wall
	'V': Vector2i(6, 0),   # Village
	'@': Vector2i(0, 1),   # Player
	'T': Vector2i(1, 1),   # Trader
	'X': Vector2i(2, 1),   # Enemy
	'S': Vector2i(3, 1),   # Start
	'R': Vector2i(4, 1),   # Shelter
	'!M': Vector2i(0, 2),  # Main Quest
	'!S': Vector2i(1, 2),  # Sub Quest
	'A': Vector2i(2, 2),   # Crossroads
	'H': Vector2i(3, 2),   # Herbalist
	'B': Vector2i(4, 2),   # Library
	'L': Vector2i(5, 2),   # Lab
	'N': Vector2i(6, 2),   # Nest
	'E': Vector2i(7, 2),   # Destination
}

func generate_world(tile_map: TileMap):
	print("Generating World...")
	var rows = MAP_STRING.split("\n")
	for y in range(rows.size()):
		var row = rows[y]
		for x in range(row.length()):
			var char = row[x]
			var atlas_coords = TILE_MAP.get(char, TILE_MAP['.']) # Default to grass
			
			# Set terrain on Layer 0
			tile_map.set_cell(0, Vector2i(x, y), 0, atlas_coords)
			
			# Store data in GameManager for interaction
			if char != '.':
				GameManager.world_grid[Vector2i(x, y)] = char
			
			# Handle POIs and Actors (could be on a different layer or spawn entities)
			if char in ['@', 'S', 'R', 'A', 'H', 'B', 'L', 'N', 'E', 'T', 'X']:
				# For now, just mark them on the map. In a real game, we'd spawn nodes.
				# We can use Layer 1 for objects if we want
				if tile_map.get_layers_count() > 1:
					tile_map.set_cell(1, Vector2i(x, y), 0, atlas_coords)
				
				if char == '@' or char == 'S':
					GameManager.player_pos = Vector2i(x, y)
					# Debug: Spawn a test item near start
					var item_pos = Vector2i(x + 2, y)
					GameManager.world_items[item_pos] = "CONS_001" # Razione di cibo
					print("Spawned test item at: ", item_pos)
					print("Player start found at: ", x, ",", y)

	print("World Generation Complete.")
