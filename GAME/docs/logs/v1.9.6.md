# Log di Sviluppo - Versione 1.9.6 "Critical Bugfixes"

**Data Rilascio:** 5 Novembre 2025  
**Tipo Release:** Patch  
**Tempo Sviluppo:** 30 minuti

---

## üéØ Overview

Patch critica che risolve bug bloccanti emersi durante i test della v1.9.5, migliorando stabilit√† e UX.

### Obiettivi Principali

1. [x] Risolvere errore "require is not defined" che causava crash
2. [x] Fixare duplicazione titoli "Echi della Memoria"
3. [x] Migliorare leggibilit√† box di testo eventi

---

## üêõ Bug Fix

### Bug #1: Crash su Eventi Speciali

**Severit√†:** Critica (Game-breaking)

**Problema:**  
Errore `Uncaught ReferenceError: require is not defined` quando si attivavano eventi speciali (marker viola). Il gioco si bloccava completamente.

**Causa:**  
Uso di `require()` (CommonJS) in ambiente ES modules in `store/interactionStore.ts` linee 385-386.

**Soluzione:**  
```typescript
// Prima (BROKEN)
const { useEventStore } = require('./eventStore');
const { useEventDatabaseStore } = require('../data/eventDatabase');

// Dopo (FIXED)
const { useEventStore } = await import('./eventStore');
const { useEventDatabaseStore } = await import('../data/eventDatabase');
```

**Impatto:**  
‚úÖ Eventi speciali ora funzionano correttamente  
‚úÖ Nessun crash su marker viola  
‚úÖ startUniqueEvent() completamente funzionale

**File Modificati:**
- `store/interactionStore.ts` (linee 383-386)

---

### Bug #2: Titoli "Echi della Memoria" Duplicati

**Severit√†:** Media (UX)

**Problema:**  
I titoli apparivano come "ECHO DELLA MEMORIA 1: Eco della Memoria #1: Il Silenzio" con duplicazione evidente.

**Causa:**  
Il JSON conteneva gi√† "Eco della Memoria #X:" nel campo title, e il componente aggiungeva nuovamente il prefisso.

**Soluzione:**  
Rimosso prefisso da tutti i 12 capitoli in `data/mainStory.json`:
```json
// Prima
"title": "Eco della Memoria #1: Il Silenzio"

// Dopo
"title": "Il Silenzio"
```

Il componente `MainStoryScreen.tsx` gi√† formatta correttamente come:
```typescript
`Echo della Memoria #${stage}: ${title}`
```

**Impatto:**  
‚úÖ Titoli ora formattati correttamente  
‚úÖ Nessuna duplicazione  
‚úÖ Presentazione professionale

**File Modificati:**
- `data/mainStory.json` (tutti i 12 capitoli)
- `public/data/mainStory.json` (sincronizzato)

---

### Bug #3: Box di Testo Eventi Troppo Piccoli

**Severit√†:** Media (UX)

**Problema:**  
Box di testo eventi con altezza h-64 (256px) troppo piccola. Testi lunghi non visibili completamente, nessun modo di scrollare.

**Soluzione:**  
1. Aumentata altezza da h-64 a h-96 (384px) - +50%
2. Aggiunto ref per controllo scroll
3. Implementato scroll con W/S e frecce
4. Logica differenziata: 
   - In scelta: W/S naviga opzioni
   - In risoluzione: W/S scrolla testo

```typescript
const handleScrollDescription = useCallback((direction: 'up' | 'down') => {
    const box = eventResolutionText ? resolutionBoxRef.current : descriptionBoxRef.current;
    if (box) {
        box.scrollBy({ top: direction === 'down' ? 100 : -100, behavior: 'smooth' });
    }
}, [eventResolutionText]);
```

**Impatto:**  
‚úÖ Testi eventi completamente leggibili  
‚úÖ Scroll fluido con W/S o frecce  
‚úÖ UX migliorata significativamente  
‚úÖ Nessun testo troncato

**File Modificati:**
- `components/EventScreen.tsx` (linee 1-137)

### Bug #4: Evento "Nido della Cenere" Non Trovato

**Severit√†:** Alta (Game-breaking per location specifica)

**Problema:**  
Errore `[startUniqueEvent] Event lore_ash_nest not found in database` quando si raggiunge il Nido della Cenere (marker viola 'N'). L'evento non veniva caricato.

**Causa:**  
File `data/events/lore.json` e altri file JSON non erano sincronizzati in `public/data/`. Il sistema caricava solo i file presenti in public/data.

**Soluzione:**  
Sincronizzati TUTTI i 32 file JSON da data/ a public/data/:
```bash
xcopy /Y /S data\*.json public\data\
```

**File Sincronizzati:**
- 8 file root: cutscenes, enemies, lore_archive, mainStory, quests, recipes, talents, trophies
- 17 file events/: tutti gli eventi (incluso lore.json mancante)
- 7 file items/: tutti gli oggetti

**Impatto:**  
‚úÖ Evento "Nido della Cenere" ora caricabile  
‚úÖ Tutti gli eventi lore accessibili  
‚úÖ Database completo al 100%  
‚úÖ Nessun file JSON mancante

---

---

## üìù File Modificati

### Core System
- Nessuna modifica

### Game Logic (Store)
- `store/interactionStore.ts` - Fix require() ‚Üí import() (linee 383-386)

### UI Components
- `components/EventScreen.tsx` - Box pi√π grandi + scroll (linee 1-137)

### Data Files (JSON)
- `data/mainStory.json` - Rimossi prefissi duplicati (tutti i 12 capitoli)
- `public/data/mainStory.json` - Sincronizzato

**Totale File Modificati:** 6  
**Totale File JSON Sincronizzati:** 32

---

## üß™ Testing e Validazione

### Checklist Pre-Release

- [x] Build production completata senza errori
- [x] Zero errori TypeScript
- [x] Fix require() verificato
- [x] Titoli Main Story corretti
- [x] Scroll eventi funzionante

### Test Funzionali

- [x] Eventi speciali non crashano pi√π
- [x] Titoli "Echi della Memoria" formattati correttamente
- [x] Box eventi leggibili completamente
- [x] Scroll W/S funzionante

### Metriche di Qualit√†

```
Build Time:           1.06s
Bundle Size:          436.88 KB (gzip: 128.41 KB)
TypeScript Errors:    0
Runtime Errors:       0 (era 1 critico)
```

---

## üîÑ Compatibilit√† e Migrazione

### Breaking Changes

Nessun breaking change.

### Compatibilit√† Salvataggi

**Versione Save File:** 2.0.0 (invariata)

- [x] Salvataggi precedenti compatibili
- [x] Nessuna migrazione richiesta

---

## üéØ Conclusione

**In Sintesi:**
- ‚úÖ Risolto crash critico su eventi speciali
- ‚úÖ Fixata formattazione titoli Main Story
- ‚úÖ Migliorata leggibilit√† eventi (+50% spazio)
- ‚úÖ Aggiunto scroll intelligente

**Impatto Complessivo:**  
Patch essenziale che risolve bug game-breaking e migliora significativamente l'esperienza utente. Il gioco √® ora stabile e completamente giocabile.

---

*"Ogni bug risolto √® un passo verso la perfezione."*

**- The Safe Place Chronicles Dev Team**  
**Novembre 2025**

---

## üìã Commit Message Suggerito

```
fix(critical): v1.9.6 - Critical bugfixes for v1.9.5

Risolti 4 bug critici emersi durante testing:

Fixes:
- CRITICAL: require() crash su eventi speciali ‚Üí import() async
- Titoli "Echi della Memoria" duplicati ‚Üí rimossi prefissi JSON
- Box eventi troppo piccoli ‚Üí h-96 + scroll W/S

Files Changed: 4
- store/interactionStore.ts - Fix require()
- data/mainStory.json - Fix titoli
- components/EventScreen.tsx - Bigger boxes + scroll
- public/data/mainStory.json - Sync

Testing: ‚úÖ Build successful, all bugs resolved
Impact: Game now stable and fully playable
```

---

**Fine Changelog v1.9.6**