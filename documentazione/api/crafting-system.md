# Sistema di Crafting - The Safe Place\n\n## Panoramica\n\nIl sistema di crafting di The Safe Place permette ai giocatori di creare, migliorare e riparare oggetti utilizzando materiali raccolti durante l'esplorazione. Il sistema è progettato per essere intuitivo, accessibile e performante.\n\n## Architettura\n\n### Componenti Principali\n\n```\nsrc/\n├── components/crafting/          # Componenti UI\n│   ├── CraftingScreen.tsx       # Schermata principale\n│   ├── RecipeList.tsx           # Lista ricette\n│   ├── RecipeDetails.tsx        # Dettagli ricetta\n│   ├── ItemPreview.tsx          # Anteprima oggetto\n│   └── CraftingActionBar.tsx    # Barra azioni\n├── stores/\n│   └── craftingStore.ts         # Store Zustand\n├── types/\n│   └── crafting.ts              # Definizioni TypeScript\n├── utils/\n│   ├── craftingUtils.ts         # Utility generali\n│   ├── craftingTypes.ts         # Gestione tipologie\n│   ├── recipeLoader.ts          # Caricamento ricette\n│   └── craftingOptimizations.ts # Ottimizzazioni performance\n├── data/\n│   └── recipes.json             # Database ricette\n└── tests/                       # Test suite completa\n```\n\n### Flusso di Dati\n\n```mermaid\ngraph TD\n    A[recipes.json] --> B[recipeLoader]\n    B --> C[craftingStore]\n    C --> D[CraftingScreen]\n    D --> E[RecipeList]\n    D --> F[RecipeDetails]\n    D --> G[ItemPreview]\n    D --> H[CraftingActionBar]\n    \n    I[gameStore] --> C\n    C --> I\n    \n    J[User Input] --> D\n    D --> K[Crafting Logic]\n    K --> I\n```\n\n## Tipologie di Crafting\n\n### 1. Creation (Creazione)\nCreazione di oggetti completamente nuovi da materiali base.\n\n```typescript\nconst creationRecipe: Recipe = {\n  id: 'knife_sharp',\n  type: 'creation',\n  resultItemId: 'knife_sharp',\n  resultQuantity: 1,\n  components: [\n    { itemId: 'knife_dull', quantity: 1 },\n    { itemId: 'whetstone', quantity: 1 }\n  ]\n};\n```\n\n### 2. Upgrade (Miglioramento)\nMiglioramento di oggetti esistenti con statistiche potenziate.\n\n```typescript\nconst upgradeRecipe: Recipe = {\n  id: 'knife_reinforced',\n  type: 'upgrade',\n  resultItemId: 'knife_reinforced',\n  resultQuantity: 1,\n  components: [\n    { itemId: 'metal_scrap', quantity: 2 }\n  ],\n  upgradeConfig: {\n    baseItemId: 'knife_sharp',\n    upgradeLevel: 1,\n    consumeBaseItem: true,\n    improvements: {\n      damageBonus: 2,\n      durabilityBonus: 50\n    }\n  }\n};\n```\n\n### 3. Repair (Riparazione)\nRipristino della durabilità di oggetti danneggiati.\n\n```typescript\nconst repairRecipe: Recipe = {\n  id: 'repair_weapons',\n  type: 'repair',\n  components: [\n    { itemId: 'repair_kit', quantity: 1 }\n  ],\n  repairConfig: {\n    repairableTypes: ['weapon', 'tool'],\n    durabilityRestored: 75,\n    canFail: true,\n    successChance: 85\n  }\n};\n```\n\n### 4. Dismantle (Smantellamento)\nRecupero di materiali da oggetti non più utili.\n\n```typescript\nconst dismantleRecipe: Recipe = {\n  id: 'dismantle_electronics',\n  type: 'dismantle',\n  resultItemId: 'electronic_parts',\n  resultQuantity: 3,\n  components: [\n    { itemId: 'broken_radio', quantity: 1 }\n  ]\n};\n```\n\n### 5. Enhancement (Potenziamento)\nAggiunta di proprietà speciali agli oggetti.\n\n```typescript\nconst enhancementRecipe: Recipe = {\n  id: 'armor_spikes',\n  type: 'enhancement',\n  resultItemId: 'leather_armor_spiked',\n  resultQuantity: 1,\n  upgradeConfig: {\n    baseItemId: 'leather_armor',\n    improvements: {\n      specialProperties: ['thorns', 'intimidating']\n    }\n  }\n};\n```\n\n## Store Management\n\n### CraftingStore (Zustand)\n\n```typescript\ninterface CraftingState {\n  // Stato UI\n  selectedRecipeIndex: number;\n  isOpen: boolean;\n  \n  // Dati\n  allRecipes: Recipe[];\n  knownRecipeIds: string[];\n  \n  // Azioni\n  setSelectedRecipe: (index: number) => void;\n  openCrafting: () => void;\n  closeCrafting: () => void;\n  craftItem: (recipeId: string) => Promise<boolean>;\n  \n  // Selettori\n  getAvailableRecipes: () => Recipe[];\n  canCraftRecipe: (recipeId: string) => boolean;\n  getMaterialStatus: (recipeId: string) => MaterialStatus[];\n}\n```\n\n### Integrazione con GameStore\n\nIl crafting store si integra con il game store per:\n- Accesso all'inventario del giocatore\n- Modifica degli oggetti (aggiunta/rimozione)\n- Gestione dell'esperienza\n- Logging delle azioni\n\n## Validazioni\n\n### Validazione Ricette\n\n```typescript\nexport const validateCraftingAttempt = (\n  recipe: Recipe,\n  inventory: InventoryItem[],\n  character: CharacterSheet\n): CraftingValidationResult => {\n  // Verifica materiali\n  const materialStatus = getMaterialStatus(recipe, inventory, {});\n  const hasMaterials = materialStatus.every(m => m.sufficient);\n  \n  if (!hasMaterials) {\n    return createFailureResult('Materiali insufficienti');\n  }\n  \n  // Verifica abilità\n  if (recipe.skillRequirement) {\n    const hasSkill = meetsSkillRequirement(recipe, character);\n    if (!hasSkill) {\n      return createFailureResult('Abilità insufficiente');\n    }\n  }\n  \n  return createSuccessResult();\n};\n```\n\n### Controlli di Sicurezza\n\n- Verifica disponibilità materiali\n- Controllo requisiti abilità\n- Validazione spazio inventario\n- Verifica condizioni speciali\n- Controllo posizione (solo nei rifugi)\n\n## Ottimizzazioni Performance\n\n### Memoizzazione\n\n```typescript\n// Hook per memoizzare ricette disponibili\nexport const useMemoizedAvailableRecipes = (\n  allRecipes: Recipe[],\n  knownRecipeIds: string[]\n): Recipe[] => {\n  return useMemo(() => {\n    return allRecipes.filter(recipe => \n      knownRecipeIds.includes(recipe.id)\n    );\n  }, [allRecipes, knownRecipeIds]);\n};\n```\n\n### Cache LRU\n\n```typescript\nclass LRUCache<T> {\n  private cache = new Map<string, CacheEntry<T>>();\n  private maxSize: number;\n  private maxAge: number;\n  \n  get(key: string): T | null {\n    // Implementazione cache con scadenza\n  }\n  \n  set(key: string, data: T): void {\n    // Gestione LRU con limite dimensioni\n  }\n}\n```\n\n### Batch Operations\n\n```typescript\nexport const processBatchRecipeValidation = (\n  recipes: Recipe[],\n  inventory: InventoryItem[],\n  character: CharacterSheet\n): { craftable: Recipe[]; uncraftable: Recipe[] } => {\n  // Elaborazione batch per migliori performance\n};\n```\n\n## Accessibilità\n\n### Supporto Tastiera\n\n- **W/S o Frecce**: Navigazione lista ricette\n- **Enter**: Conferma crafting\n- **ESC**: Uscita dalla schermata\n- **Tab**: Navigazione tra sezioni\n\n### ARIA Support\n\n```tsx\n<div \n  role=\"application\"\n  aria-label=\"Sistema di Crafting\"\n>\n  <div role=\"list\" aria-label=\"Lista Ricette\">\n    {recipes.map((recipe, index) => (\n      <div\n        key={recipe.id}\n        role=\"listitem\"\n        aria-selected={index === selectedIndex}\n        aria-describedby={`recipe-${index}-description`}\n      >\n        <span>{recipe.name}</span>\n        <span \n          id={`recipe-${index}-description`}\n          aria-live=\"polite\"\n        >\n          {recipe.canCraft ? 'Craftabile' : 'Materiali insufficienti'}\n        </span>\n      </div>\n    ))}\n  </div>\n</div>\n```\n\n### Screen Reader Support\n\n- Etichette descrittive per tutti gli elementi\n- Regioni live per aggiornamenti dinamici\n- Istruzioni chiare per l'utente\n- Feedback audio per azioni\n\n## Testing\n\n### Test Suite\n\n```\ntests/\n├── craftingStore.test.ts        # Test store Zustand\n├── craftingUtils.test.ts        # Test utility functions\n├── craftingTypes.test.ts        # Test tipologie crafting\n├── craftingLogic.test.ts        # Test logica core\n├── craftingE2E.test.ts          # Test end-to-end\n├── craftingAccessibility.test.ts # Test accessibilità\n├── craftingIntegration.test.ts  # Test integrazione\n└── CraftingScreen.test.tsx      # Test componenti UI\n```\n\n### Copertura Test\n\n- **Unit Tests**: Funzioni individuali e componenti\n- **Integration Tests**: Interazione tra componenti\n- **E2E Tests**: Flussi completi utente\n- **Accessibility Tests**: Supporto screen reader e tastiera\n- **Performance Tests**: Stress test e ottimizzazioni\n\n### Esecuzione Test\n\n```bash\n# Tutti i test\nnpm test\n\n# Test specifici\nnpm test crafting\n\n# Test con coverage\nnpm test -- --coverage\n\n# Test in watch mode\nnpm test -- --watch\n```\n\n## Configurazione\n\n### Costanti di Sistema\n\n```typescript\nexport const CRAFTING_CONFIG = {\n  MAX_RECIPES_CACHE: 100,\n  CACHE_DURATION: 5 * 60 * 1000, // 5 minuti\n  MAX_COMPONENT_QUANTITY: 99,\n  MIN_COMPONENT_QUANTITY: 1,\n  DEBUG_ENABLED: process.env.NODE_ENV === 'development'\n};\n```\n\n### Regole di Validazione\n\n```typescript\nexport const VALIDATION_RULES = {\n  MIN_RECIPE_ID_LENGTH: 3,\n  MAX_RECIPE_ID_LENGTH: 50,\n  MIN_RESULT_QUANTITY: 1,\n  MAX_RESULT_QUANTITY: 10,\n  MIN_SKILL_REQUIREMENT: 1,\n  MAX_SKILL_REQUIREMENT: 20\n};\n```\n\n## Estensibilità\n\n### Aggiungere Nuove Tipologie\n\n1. Estendere il tipo `RecipeType`:\n```typescript\nexport type RecipeType = 'creation' | 'upgrade' | 'repair' | 'dismantle' | 'enhancement' | 'new_type';\n```\n\n2. Implementare handler in `craftingTypes.ts`:\n```typescript\nconst handleNewTypeCrafting = (\n  recipe: Recipe,\n  inventory: InventoryItem[],\n  character: CharacterSheet,\n  itemDatabase: Record<string, ItemData>\n): CraftingResult => {\n  // Implementazione logica specifica\n};\n```\n\n3. Aggiungere al dispatcher:\n```typescript\nswitch (recipeType) {\n  case 'new_type':\n    return handleNewTypeCrafting(recipe, inventory, character, itemDatabase);\n  // ...\n}\n```\n\n### Aggiungere Nuove Ricette\n\n1. Aggiungere al file `recipes.json`:\n```json\n{\n  \"id\": \"new_recipe\",\n  \"type\": \"creation\",\n  \"resultItemId\": \"new_item\",\n  \"resultQuantity\": 1,\n  \"components\": [\n    { \"itemId\": \"material1\", \"quantity\": 2 }\n  ],\n  \"description\": \"Descrizione ricetta\"\n}\n```\n\n2. Aggiungere oggetto risultante al database items\n\n3. Testare con la suite di test esistente\n\n## Troubleshooting\n\n### Problemi Comuni\n\n#### Ricette Non Visibili\n- Verificare che siano in `knownRecipeIds`\n- Controllare il caricamento da `recipes.json`\n- Verificare validazione ricetta\n\n#### Crafting Non Funziona\n- Verificare materiali in inventario\n- Controllare requisiti abilità\n- Verificare posizione (deve essere in rifugio)\n\n#### Performance Lente\n- Verificare dimensioni cache\n- Controllare memoizzazione componenti\n- Analizzare re-render non necessari\n\n### Debug\n\n```typescript\n// Abilitare debug logging\nCRAFTING_CONFIG.DEBUG_ENABLED = true;\n\n// Verificare stato cache\nconst stats = getCacheStats();\nconsole.log('Cache stats:', stats);\n\n// Pulire cache se necessario\nclearAllCaches();\n```\n\n### Logging\n\n```typescript\n// Logging automatico per azioni importanti\ndebugLog('craftItem', `Crafting ${recipeId}`);\ndebugLog('validation', `Recipe ${recipeId} validation failed: ${reason}`);\ndebugLog('performance', `Operation took ${duration}ms`);\n```\n\n## Roadmap\n\n### Funzionalità Future\n\n- [ ] Crafting collaborativo multiplayer\n- [ ] Ricette procedurali generate dinamicamente\n- [ ] Sistema di specializzazioni crafting\n- [ ] Workbench con upgrade\n- [ ] Automazione crafting\n- [ ] Ricette stagionali/temporanee\n- [ ] Sistema di qualità materiali\n- [ ] Crafting con mini-giochi\n\n### Miglioramenti Tecnici\n\n- [ ] Web Workers per calcoli pesanti\n- [ ] IndexedDB per cache persistente\n- [ ] Service Worker per offline support\n- [ ] WebAssembly per validazioni complesse\n- [ ] Real-time sync per multiplayer\n\n## Contribuire\n\n### Linee Guida\n\n1. **Seguire TypeScript strict mode**\n2. **Scrivere test per nuove funzionalità**\n3. **Mantenere accessibilità**\n4. **Documentare API pubbliche**\n5. **Ottimizzare per performance**\n\n### Pull Request\n\n1. Fork del repository\n2. Creare branch feature\n3. Implementare con test\n4. Aggiornare documentazione\n5. Sottomettere PR con descrizione dettagliata\n\n---\n\n*Documentazione aggiornata: Dicembre 2024*\n*Versione Sistema: 1.0.0*"

## Interfaccia Terminale (v0.8.1+)

### Panoramica
A partire dalla versione 0.8.1, il sistema di crafting include una **nuova interfaccia terminale autentica** che trasforma l'esperienza di crafting in un'interfaccia anni '80 completamente keyboard-driven.

### Caratteristiche Principali
- **Layout ASCII**: Bordi e separatori con caratteri ═║╔╗╚╝
- **Navigazione Keyboard**: Controllo completo senza mouse
- **Performance Ottimizzate**: Rendering <50ms, -30% memoria
- **Compatibilità Totale**: Zero breaking changes con sistema esistente

### Comandi Terminale
```
================================================================================
                              BANCO DI LAVORO
================================================================================
[W/S] Naviga  [ENTER] Crafta  [ESC] Esci  [1-9] Selezione  [F] Filtri  [H] Aiuto
================================================================================
```

### Stati Interfaccia
- **Normale**: Lista ricette e dettagli
- **Loading**: Progress bar ASCII durante crafting
- **Success**: Messaggio successo con XP
- **Error**: Gestione errori con codici specifici

### Implementazione Tecnica
```typescript
// Componente principale
<TerminalCraftingScreen />

// Hook ottimizzazioni
const { memoizedRender, performanceMetrics } = useTerminalOptimizations();

// Feature flag per attivazione
const useTerminalInterface = useFeatureFlag('TERMINAL_CRAFTING');
```

### Supporto Tastiera Avanzato

#### Comandi Base
- **W/S o Frecce**: Navigazione lista ricette
- **Enter**: Conferma crafting
- **ESC**: Uscita dalla schermata
- **Tab**: Navigazione tra sezioni

#### Comandi Avanzati
- **1-9**: Selezione diretta ricetta per numero
- **F**: Toggle filtri disponibilità
- **H**: Aiuto contestuale e tutorial interattivo
- **Ctrl+R**: Refresh lista ricette
- **Shift+Tab**: Navigazione inversa

#### Scorciatoie Rapide
- **Ctrl+1-4**: Salta a categorie specifiche
- **Ctrl+0**: Mostra tutte le categorie

---

*Documentazione aggiornata: Agosto 2025*
*Versione Sistema: 1.1.0 (Terminal Interface)*